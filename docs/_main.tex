% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{plainnat}
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={WildlifeSystems - biodiversity technologies},
  pdfauthor={Ed Baker},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{WildlifeSystems - biodiversity technologies}
\author{Ed Baker}
\date{2022-10-04}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{about}{%
\chapter*{About}\label{about}}
\addcontentsline{toc}{chapter}{About}

This book explains the technologies developed as part of WildlifeSystems and how they can be implemented in real-world scenarios.

\hypertarget{support}{%
\section*{Support}\label{support}}
\addcontentsline{toc}{section}{Support}

WildlifeSystems nodes were originally developed and used as part of the Leverhulme Trust funded Automated Acoustic Observatories project at the University of York. Additional development is undertaken as part of the Urban Nature Project at the Natural History Museum, London.

\hypertarget{biodiversity-technologies}{%
\chapter{Biodiversity Technologies}\label{biodiversity-technologies}}

What are \emph{Biodiversity Technologies}?

\hypertarget{structure-of-wildlife-systems}{%
\section{Structure of Wildlife Systems}\label{structure-of-wildlife-systems}}

\hypertarget{overall-philosophy}{%
\subsection{Overall Philosophy}\label{overall-philosophy}}

\hypertarget{packages}{%
\subsection{Packages}\label{packages}}

\hypertarget{sensor-networks}{%
\chapter{Sensor Networks}\label{sensor-networks}}

\hypertarget{environmental-sensors}{%
\chapter{Environmental Sensors}\label{environmental-sensors}}

\hypertarget{how-sensors-work}{%
\section{How sensors work}\label{how-sensors-work}}

\hypertarget{temperature}{%
\subsection{Temperature}\label{temperature}}

\hypertarget{humidity}{%
\subsection{Humidity}\label{humidity}}

\hypertarget{air-pressure}{%
\subsection{Air Pressure}\label{air-pressure}}

\hypertarget{gases}{%
\subsection{Gases}\label{gases}}

\hypertarget{heated-gas-resistance}{%
\subsubsection{Heated Gas Resistance}\label{heated-gas-resistance}}

\hypertarget{sensors-in-wildlifesystems}{%
\chapter{Sensors in WildlifeSystems}\label{sensors-in-wildlifesystems}}

The WildlifeSystems platform comes with support for some popular existing environmental sensors, although there are many on the market and the range available is subject to constant change. The modular nature of WildlifeSystems allows for new sensors to be easily integrated if the need arises.

\hypertarget{sensors-included-in-the-base-system}{%
\section{Sensors included in the base system}\label{sensors-included-in-the-base-system}}

The Raspberry Pi does not come with environmental sensors, however there are several onboard sensors that are used to monitor the operation of the hardware, to prevent crucial components from overheating, including the temperature of the CPU and GPU chips. WildlifeSystems provides access to these sensors through the \texttt{sensor-onboard} package, as well as providing some \emph{software sensors} that report the free memory and free SD storage available. These can be useful for detecting and resolving possible issues on a sensor node before a serious problem arises.

\hypertarget{installing-sensor-support}{%
\section{Installing sensor support}\label{installing-sensor-support}}

Support for sensors is installed as part of the node installation process, however it is possible to install the \texttt{sensor-control} abstraction layer onto any Raspberry Pi system using the command below.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wget} \AttributeTok{{-}O} \AttributeTok{{-}}\NormalTok{ https://raw.githubusercontent.com/Wildlife{-}Systems/sensor{-}control/main/install }\KeywordTok{|} \FunctionTok{sudo}\NormalTok{ bash}
\end{Highlighting}
\end{Shaded}

This will install the \texttt{sensor-control} and \texttt{sensor-onboard} scripts into the system, as well as installing a small of number of supporting packages if they are not already installed.

\hypertarget{reading-data-from-a-sensor}{%
\section{Reading data from a sensor}\label{reading-data-from-a-sensor}}

The sensor read command, \texttt{sr}, can be used to read sensor data.

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{sr}\NormalTok{ onboard}
\end{Highlighting}
\end{Shaded}

This will give a JSON string listing information about each sensor, and the current reading. This information can be presented in a more human readable form by piping the output to the program \texttt{jq}, a command line JSON processor.

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{sr}\NormalTok{ onboard }\KeywordTok{|} \ExtensionTok{jq}
\end{Highlighting}
\end{Shaded}

\hypertarget{the-sensor-reading-process}{%
\section{The sensor reading process}\label{the-sensor-reading-process}}

The sensor reading process in WildlifeSystems has five steps.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  The \texttt{sr} command identifies which sensor script to route the request to.
\item
  The sensor script calls the \texttt{sc-prototype} script to obtain a template (``prototype'') of the JSON request.
\item
  The sensor script access the relevant sensor(s) and populates the values in a template for each sensor reading, before returning a JSON array of populated readings to \texttt{sr}.
\item
  The \texttt{sr} script populates additional information for each reading, providing the \texttt{node\_id} and a \texttt{timestamp} for each.
\item
  \texttt{sr} returns the finalised JSON array to the user.
\end{enumerate}

\hypertarget{installing-new-sensors}{%
\section{Installing new sensors}\label{installing-new-sensors}}

\hypertarget{implementing-new-sensors}{%
\chapter{Implementing new sensors}\label{implementing-new-sensors}}

New sensors should be implemented as new packages (i.e, a new GitHub repository). Packages have a standard format, and should be named \texttt{sensor-\textless{}sensor-name\textgreater{}} where \texttt{\textless{}sensor-name\textgreater{}} is short, descriptive of the sensor (e.g.~model number), and unique within the WildlifeSystems ecosystem.

The structure of a basic package is given below.

\begin{verbatim}
.
+-- inst
|   +-- files that are not part of the package structure
|       used during installation (e.g. 3rd party scripts 
|       to be copied to /usr/bin/)
|
+-- sensor-<sensor-name>
|     Executable to read sensor and print JSON of readings
|     (copied on install to /usr/bin/)
|
+-- <sensor-name>
|     Configuration file 
|     (copied on install to /var/aao/sensors/)
|
+-- install
|     Bash file run once on install - used to install packaged
|     dependencies, etc.
\end{verbatim}

As many people implement various sensors on the Raspberry Pi, it is likely that some sort of solution is already available, that can be tweaked to output readings in the standard format required. However, you must ensure that any licensing conditions are met. In particular, an open license is required if submitting your sensor package to WildlifeSystems for inclusion in the ecosystem.

\hypertarget{reading-the-sensor}{%
\section{Reading the sensor}\label{reading-the-sensor}}

File \texttt{sensor-\textless{}sensor-name\textgreater{}} provides the functionality to read the protoype JSON, populate the JSON with sensor readings, and print the output.

The file can be written in any programming or scripting language, but to prevent overhead consideration should be given to minimising the number of new packages installed.

\hypertarget{in-bash}{%
\subsection{In bash}\label{in-bash}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#!/bin/bash}

\CommentTok{\# Read the prototype JSON}
\VariableTok{JSON}\OperatorTok{=}\VariableTok{$(}\ExtensionTok{sc{-}prototype}\VariableTok{)}

\BuiltInTok{echo} \AttributeTok{{-}n} \StringTok{"["}

\CommentTok{\# Code to read the sensor value into GPU\_TEMP}

\CommentTok{\# Use \textasciigrave{}jq\textasciigrave{} to modify JSON}
\VariableTok{SENSOR}\OperatorTok{=}\VariableTok{$(}\BuiltInTok{echo} \VariableTok{$JSON} \KeywordTok{|} \ExtensionTok{jq} \StringTok{".sensor |= }\DataTypeTok{\textbackslash{}"}\StringTok{onboard\_gpu}\DataTypeTok{\textbackslash{}"}\StringTok{ | .measures |= }\DataTypeTok{\textbackslash{}"}\StringTok{temperature}\DataTypeTok{\textbackslash{}"}\StringTok{ | .unit |= }\DataTypeTok{\textbackslash{}"}\StringTok{Celsius}\DataTypeTok{\textbackslash{}"}\StringTok{| .value |= }\VariableTok{$\{GPU\_TEMP\}}\StringTok{"}\VariableTok{)}
\BuiltInTok{echo} \AttributeTok{{-}n} \VariableTok{$SENSOR}

\BuiltInTok{echo} \StringTok{"]"}
\end{Highlighting}
\end{Shaded}

\hypertarget{in-python}{%
\subsection{In Python}\label{in-python}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#!/}
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ json}

\CommentTok{\# Read the prototype JSON}
\NormalTok{stream }\OperatorTok{=}\NormalTok{ os.popen(}\StringTok{\textquotesingle{}sc{-}prototype\textquotesingle{}}\NormalTok{)}
\NormalTok{output }\OperatorTok{=}\NormalTok{ stream.read()}

\CommentTok{\# Pre{-}populate with sensor metadata}
\NormalTok{temperature }\OperatorTok{=}\NormalTok{ json.loads(output)}
\NormalTok{temperature[}\StringTok{"sensor"}\NormalTok{] }\OperatorTok{=} \StringTok{"bme680\_temperature"}
\NormalTok{temperature[}\StringTok{"measures"}\NormalTok{] }\OperatorTok{=} \StringTok{"temperature"}
\NormalTok{temperature[}\StringTok{"unit"}\NormalTok{] }\OperatorTok{=} \StringTok{"Celsius"}

\CommentTok{\# Code to read sensor and output in variable \textasciigrave{}sensor\_reading\textasciigrave{}}
\NormalTok{temperature[}\StringTok{"value"}\NormalTok{] }\OperatorTok{=}\NormalTok{ sensor\_reading}

\CommentTok{\# Output the JSON in an array}
\BuiltInTok{print}\NormalTok{(}\StringTok{"["}\NormalTok{,json.dumps(temperature),}\StringTok{"]"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{setting-the-environment}{%
\section{Setting the environment}\label{setting-the-environment}}

The file \texttt{\textless{}sensor-name\textgreater{}} in the package specifies information that modify the environment of the Raspberry Pi (e.g.~if the i2c interface should be enabled) before the \texttt{sensor-\textless{}sensor-name\textgreater{}} script is run. This allows sensors with different requirements to run sequentially on the same node.

The file must always be present, even if it is empty. During installation the file is moved to \texttt{/var/aao/sensors/} and the list of files in this directory indicates to the system which sensors are installed.

TODO: i2c

\hypertarget{install}{%
\section{Install}\label{install}}

The file \texttt{install} in the directory is run once, when the sensor package is installed. This allows for the installation of packages and scripts necessary for the functioning of the package.

The file is executed by \texttt{bash} and the use of \texttt{sudo} is allowed.

\hypertarget{the-installation-process-with-si}{%
\section{\texorpdfstring{The installation process with \texttt{si}}{The installation process with si}}\label{the-installation-process-with-si}}

The sensor install script, \texttt{si}, from \texttt{sensor-control} is used to install sensor packages. For developer reference the installation process is described below.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \texttt{si} clones the \texttt{Wildlife-Systems/sensor-\textless{}sensor-name\textgreater{}} repository from GitHub.
\item
  The \texttt{install} script is executed.
\item
  \texttt{sensor-\textless{}sensor-name} is marked as executable and move to /usr/bin/.
\item
  \texttt{\textless{}sensor-name\textgreater{}} is moved to /var/aao/sensors/.
\item
  The cloned repository is removed from the local filesystem.
\end{enumerate}

\hypertarget{submitting-packages-to-wildlifesystems}{%
\section{Submitting packages to WildlifeSystems}\label{submitting-packages-to-wildlifesystems}}

Submitting packages (where licensing allows) to WildlifeSystems allows the ecosystem to be developed and sustained collaboratively by the user community.

Packages can be sent to the administrators as a compressed file, or a request can be sent to fork an existing GitHub repository. Contact details can be found at \url{https://wildlife.systems/contact.html}.

\hypertarget{sound-devices}{%
\chapter{Sound Devices}\label{sound-devices}}

\hypertarget{how-sound-devices-work}{%
\section{How sound devices work}\label{how-sound-devices-work}}

\hypertarget{sound-devices-in-wildlifesystems}{%
\chapter{Sound devices in WildlifeSystems}\label{sound-devices-in-wildlifesystems}}

\hypertarget{power-management}{%
\chapter{Power Management}\label{power-management}}

Power management on the Raspberry Pi is useful when deployments are made that are powered by batteries and/or renewable sources such as solar power that are intermittent.

In addition, there are small environmental benefits on consuming less power on systems which have continual grid power.

The \texttt{pi-pwr} script can be used to turn off unused functionality, either always or just when it is not required.

\hypertarget{installation-of-power-management-tools}{%
\section{Installation of power management tools}\label{installation-of-power-management-tools}}

The power management tools are installed as part of the node installation process, however they can be easily installed independently on any Raspberry Pi system.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wget} \AttributeTok{{-}O} \AttributeTok{{-}}\NormalTok{ https://github.com/wildlife{-}systems/pi{-}pwr/raw/master/install }\KeywordTok{|} \FunctionTok{sudo}\NormalTok{ bash}
\end{Highlighting}
\end{Shaded}

\hypertarget{turning-funtionality-on-and-off}{%
\section{Turning funtionality on and off}\label{turning-funtionality-on-and-off}}

\hypertarget{considerations}{%
\section{Considerations}\label{considerations}}

Disabling network functionality (WiFI / Ethernet) will prevent the node from communicating until either the functionality is turned back on or the Raspberry Pi is restarted. If disabling all connectivity is desired periodically then the functionality to turn these systems back on must be scripted.

\hypertarget{developer-guidelines}{%
\chapter{Developer Guidelines}\label{developer-guidelines}}

\hypertarget{documentation}{%
\section{Documentation}\label{documentation}}

There are three main kinds of documentation in the WildlifeSystems project.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Code comments}: Primarily for future you (or someone similar) to get to grips with your code. \emph{Why does this code do this?}.
\item
  \textbf{Package documentation}: Describes what your package does, how it interacts with the larger system. \emph{What will this package do for me?}
\item
  \textbf{Overall project documentation}: This manual. \emph{How do I use the entire system for my research?}
\end{enumerate}

  \bibliography{book.bib,packages.bib}

\end{document}
